<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>はなさんぽ</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-slider.min.css" rel="stylesheet">
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/bootstrap-slider.min.js"></script>
  <script src="js/jquery.csv.js"></script>
	<style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 95%; }
  </style>
  </head>
  <body>
    <div id="map"></div>
    <script type="text/javascript">
var map;
var center;
var directionsService;
var directionsDisplay;

//callback関数
function initMap() {
// center = new google.maps.LatLng({lat: 35.123827 , lng: 138.912658});
// map = new google.maps.Map(document.getElementById('map'), {
//  center: center,
// 	mapTypeId: google.maps.MapTypeId.ROADMAP,
// 	zoom: 15
// });


//パラメータの取得
// var param = getParameter();
// console.log("sanpoTime="+param["sanpoTime"]);

  if (!navigator.geolocation) {
    alert('Geolocation APIに対応していません');
    return false;
  }
  // 現在地の取得
  navigator.geolocation.getCurrentPosition(function(position) {
    // 緯度経度の取得
    if (position.coords.lat && position.coords.lng) {
      center = new google.maps.LatLng(position.coords.lat, position.coords.lng);
    } else {
      alert("現在地が取得できませんでした。とりあえずセットします。");
      center = new google.maps.LatLng({lat: 35.4119209 , lng: 136.75584329999992});
    }
    // 地図の作成
    map = new google.maps.Map(document.getElementById('map'), {
      center: center,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      zoom: 14
    });
    // 現在位置マーカーの追加
    marker = new google.maps.Marker({
      position: center,
      icon : toMyIcon(), //みしまるマーカー
      map: map
    });
    //初期化
    directionsService = new google.maps.DirectionsService();
    directionsDisplay = new google.maps.DirectionsRenderer();
    directionsDisplay.setOptions({
    　suppressMarkers: true
    });
    //マーカー出力
    //setMarkers('名所',map);
  }, function() {
    alert('位置情報取得に失敗しました');
  });
}

var arr = [];
var parkarr = [];
var marker = [];
var infoWindow = [];
var prepoint = -1;
var selectedType = "";

//データの読み込み
function loadData(type){
  selectedType = type;
  $(function() {
    $.ajax({
      url: 'data/point.csv',
      cache: false,
      timeout:10000,
      success: successHandler,
      error: errorHandler
    });
  });
}
//ajax処理成功
function successHandler(data)
{
    console.log("通信成功");
    // csvを配列に格納
    var csvList = $.csv()(data);
    //1行目はヘッダーで項目のキーにする
    var header = csvList[0];
    var cnt = 0;
    // CSVデータを設定する
    for (var i = 1; i < csvList.length; i++) {
        var row = new Array();
        for (var j=0; j < header.length; j++) {
          row[header[j]] = csvList[i][j];
        }
        arr[i] = row;
        //ここに処理を記述する
        if (row["type"] != selectedType) continue; //読み飛ばし
        console.log("name="+row["name"]+" type="+row["type"]);
        addMaker(cnt++,row);
    };
}
function errorHandler(XMLHttpRequest, textStatus, errorThrown)
{
    alert("通信失敗");
    console.log(XMLHttpRequest);
    console.log(textStatus);
    console.log(errorThrown);
}

//引数の取得
function getParameter() {
  var strprm = $(location).attr('search');
  //先頭の?を除去し、&で分割
  console.log("strprm="+strprm);
  var params = strprm.substring(1).split('&');
  var ret = new Array();
  for (var i=0;i<params.length;i++) {
    var val = params[i].split('=');
    ret[val[0]] = val[1];
  }
  return ret;
}


function setMarkers(dtd,map) {
  clearMarkers();//マーカーの削除
  loadData(dtd);//データのロード
}
//マーカーの削除
function clearMarkers() {
  for (var i = 0; i < marker.length; i++) {
     marker[i].setMap(null);
  }
  arr = [];
  marker = [];
  infoWindow = [];
  prepoint = -1;
}
//マーカーを追加する
function addMaker(idx,row) {
  //マーカー
  marker[idx] = new google.maps.Marker({
    position: {lat: parseFloat(row["lat"]), lng: parseFloat(row["lng"])},
    map: map,
    icon: toIcon(row),//ピンのアイコン
    title: row["name"]
  });
  //タップ時の情報を表示
  var context =   '<div>'+row["name"]+'</div>'
    + '<div>'+row["attribute"]+'</div>'
    + '<div>'+row["time"]+' '+row["dncd"]+'</div>'
    + '<span id="distance'+idx+'"></span>Km '
    ;
  infoWindow[idx] = new google.maps.InfoWindow({ // 吹き出しの追加
    content: context // 吹き出しに表示する内容
  });
  //
  markerEvent(idx);
}
//みしまるマーカー
function toMyIcon() {
  var pin_mishimaru = {
    url: 'images/th_mishimaru.png',
    size: new google.maps.Size(54, 82),
    origin: new google.maps.Point(0, 0),
    anchor: new google.maps.Point(54, 82)
  };
  return pin_mishimaru;
}
//ピンの色を変える
function toIcon(row) {
  var pin_blue = {
    url: 'images/th_point.png',
    size: new google.maps.Size(50, 50),
    origin: new google.maps.Point(0, 0),
    anchor: new google.maps.Point(50, 50)
  };
  var pin_red = {
    url: 'images/th_toilet.png',
    size: new google.maps.Size(50, 50),
    origin: new google.maps.Point(0, 0),
    anchor: new google.maps.Point(50, 50)
  };
  var pin_gray = {
    url: 'images/th_water.png',
    size: new google.maps.Size(50, 50),
    origin: new google.maps.Point(0, 0),
    anchor: new google.maps.Point(50, 50)
  };
  //ピンの色を判断
  var pin = pin_blue;
  if (row["type"] == "トイレ") {
  	pin = pin_red;
  } else if (row["type"] == "湧き水") {
  	pin = pin_gray;
  }
  return pin;
}
// マーカーにクリックイベントを追加
function markerEvent(i) {
    marker[i].addListener('click', function() { // マーカーをクリックしたとき
	    if (prepoint >= 0) {
		   infoWindow[prepoint].close();//前のWindowを閉じる
		}
        infoWindow[i].open(map, marker[i]); // 吹き出しの表示
		//中心からの経路を検索
		getRoute(center,marker[i].position,i);
		prepoint = i;
    });
}
//ルートを取得
//ルート描画用
function getRoute(org,dst,pst){
    var request = {
        origin: org, //入力地点の緯度、経度
        destination: dst, //到着地点の緯度、経度
        travelMode: google.maps.DirectionsTravelMode.WALKING //ルートの種類
    }
    directionsService.route(request,function(result, status){
        toRender(result);
		//移動距離を吹き出しにセット
		$("#distance"+pst).text(getDistanceKm(result.routes[0].legs));
    });
}
function toRender(result){
    directionsDisplay.setDirections(result); //取得した情報をset
    directionsDisplay.setMap(map); //マップに描画
}
//移動距離を計算
function getDistanceKm(legs) {
	var journey = 0;
    for (var i in legs) {
        journey += legs[i].distance.value;
    }
    return journey / 1000;
}

	</script>
  <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjcW-NVqpyFMZMKnkyUBKSw5nWkyevCMA&callback=initMap">
  </script>

  <button type="button" class="btn btn-default" onclick="setMarkers('名所',map)">名所</button>
  <button type="button" class="btn btn-default" onclick="setMarkers('トイレ',map)">トイレ</button>

  </body>
</html>
